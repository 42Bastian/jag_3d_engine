# -*-makefile-*-

BPE=/fun/jaguar/BigPEmu/BigPEmu.exe
JAGGD=/bin/jaggd.exe
VJ=/fun/jaguar/virtualjaguar_2.1.3/virtualjaguar.exe
MACOS=@prlexec --vm "Windows 11" -r

ifeq ($(findstring aarch64,$(MACHTYPE)),aarch64)
override BPE:=$(MACOS) $(BPE)
override JAGGD:=jaggd
override VJ:=/Applications/virtualjaguar.app/Contents/MacOS/virtualjaguar
endif

#
# SKUNK
#
.PHONY: reset
reset:
	jcp -r
	wait

.PHONY: flash
flash: $(DEMO).j64
	jcp -ef $<

.PHONY: upload
.ONESHELL:
upload: $(DEMO).cof
	@jcp -q $< 0x4000

#
# JagGD
#

.PHONY: jaggd
jaggd: bin/$(DEMO).j64
	$(JAGGD) -rd -uxr $<,a:0x800000

.PHONY: jaggd_rom
jaggd_rom: bin/$(DEMO).j64
	$(JAGGD) -rd -uxr $<,a:0x800000

#
# VirtualJaguar
#

ifeq ($(LOG),1)
override LOG:=--log
else
override LOG:= --no-log
endif

.PHONY: vjd
vjd: bin/$(DEMO).j64
	@truncate -s 1M $<
	$(VJ) -D -b $(LOG) $<

.PHONY: vj
vj: bin/$(DEMO).j64
	@truncate -s 1M $<
	$(VJ) -b $(LOG) $< &

.PHONY: vj_rom
vjd_rom: bin/$(DEMO).j64
	@truncate -s 1M $<
	$(VJ) -D -b $< &

.PHONY: vj_rom
vj_rom: bin/$(DEMO).j64
	truncate -s 1M $<
	$(VJ) -b $< &

#
# BigPEmu
#

bpe: bin/$(DEMO).j64
	$(BPE) $< -singleinst -devmode &
	true

bpel: bin/$(DEMO).j64
	$(BPE) $< -singleinst -devmode -logging &
	true

bpe_rom: bin/$(DEMO).j64
	$(BPE) $< -singleinst -devmode &
	true
